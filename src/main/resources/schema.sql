DROP TABLE IF EXISTS order_item CASCADE;
DROP TABLE IF EXISTS items CASCADE;
DROP TABLE IF EXISTS orders CASCADE;
DROP TABLE IF EXISTS baskets CASCADE;
DROP TABLE IF EXISTS users CASCADE;

CREATE TABLE IF NOT EXISTS items(
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(256) NOT NULL CHECK(name<>''),
  description TEXT NOT NULL,
  picture BYTEA NOT NULL,
  price NUMERIC(14,2) CHECK(price>=0),
  stock_quantity BIGINT NOT NULL CHECK(stock_quantity>=0),
  unit VARCHAR(256) NOT NULL
);

CREATE TABLE users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  email VARCHAR(256) NOT NULL,
  name VARCHAR(256) NOT NULL
);

CREATE TABLE orders (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  number VARCHAR(256) NOT NULL CHECK(number<>''),
  user_id BIGINT REFERENCES users(id) NOT NULL,
  created TIMESTAMP,
  total_sum NUMERIC(14,2) NOT NULL
);

CREATE TABLE order_item (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  order_id BIGINT REFERENCES orders(id),
  item_id BIGINT REFERENCES items(id),
  quantity BIGINT NOT NULL CHECK(quantity>0),
  unit VARCHAR(256) NOT NULL,
  price NUMERIC(14,2) NOT NULL CHECK(price>=0),
  sum NUMERIC(14,2) NOT NULL CHECK(price>=0),
  UNIQUE (order_id, item_id)
);

CREATE TABLE baskets (
  user_id BIGINT REFERENCES users(id),
  order_id BIGINT REFERENCES orders(id),
  PRIMARY KEY (user_id,order_id)
);